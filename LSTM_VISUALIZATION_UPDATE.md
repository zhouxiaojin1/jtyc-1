# LSTM预测结果可视化更新说明

## 📊 更新内容

### 更新时间
**2025-11-21**

---

## 🎯 主要改进

### 之前的问题
- LSTM模型输出的是`y_true`和`y_pred`两列格式
- 前端无法正确识别和展示这种格式
- 用户无法直观地看到预测值和真实值的对比

### 现在的改进
✅ **自动识别LSTM输出格式**
✅ **统一展示预测值和真实值对比**
✅ **添加多种可视化图表**
✅ **显示详细的统计指标**

---

## 📈 新增可视化功能

### 1. 预测值 vs 真实值对比图（折线图）
- **绿色实线**：真实值
- **红色虚线**：预测值
- **自动计算MAE和RMSE**，显示在图表上
- 直观展示预测效果随时间的变化

### 2. 预测误差时间序列图
- **橙色折线**：预测误差（预测值 - 真实值）
- **灰色虚线**：零误差基准线
- **阴影区域**：误差的分布范围
- 直观展示误差的变化趋势和波动

### 3. 真实值 vs 预测值散点图
- **蓝色散点**：每个时间点的真实值和预测值
- **红色虚线**：理想预测线（y=x）
- **相关系数**：显示预测值和真实值的相关性
- 评估预测的线性关系和偏差

### 4. 统计指标卡片
显示4个关键指标：
- **MAE**（平均绝对误差）：预测精度
- **RMSE**（均方根误差）：预测稳定性
- **相关系数**：预测相关性（越接近1越好）
- **MAPE**（平均百分比误差）：相对误差

---

## 🎨 可视化效果示例

### 图表布局

```
┌─────────────────────────────────────────────┐
│  检测到深度学习模型输出格式 (y_true vs y_pred) │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│         预测值 vs 真实值对比                  │
│  ───── 真实值（绿色）                        │
│  - - - 预测值（红色虚线）                     │
│  MAE: 0.1234  RMSE: 0.2345                  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│         预测误差随时间变化                     │
│  ───── 预测误差（橙色）                       │
│  - - - 零误差线（灰色）                       │
│  ████  误差分布（橙色阴影）                   │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│         散点图分析                            │
│  ● ● ● 真实值vs预测值（蓝色散点）             │
│  ───── 理想预测线 y=x（红色虚线）             │
│  相关系数: 0.9876                            │
└─────────────────────────────────────────────┘

┌────────┬────────┬────────┬────────┐
│  MAE   │  RMSE  │  相关系数 │  MAPE  │
│ 0.1234 │ 0.2345 │ 0.9876 │ 12.34% │
└────────┴────────┴────────┴────────┘
```

---

## 🚀 使用方法

### 1. 训练LSTM模型

```bash
# 启动应用
streamlit run app.py

# 在"模型训练"页面
1. 选择"LSTM"模型
2. 配置参数（或使用默认）
3. 点击"开始训练"
4. 等待训练完成
```

### 2. 查看预测结果

```bash
# 在"结果分析"页面
1. 选择"预测结果"选项卡
2. 在模型下拉列表中选择"lstm"
3. 自动展示以下内容：
   - 提示信息："检测到深度学习模型输出格式"
   - 预测值vs真实值对比图
   - 预测误差时间序列图
   - 散点图分析
   - 统计指标卡片
```

---

## 📊 指标说明

### 1. MAE（Mean Absolute Error）- 平均绝对误差
- **含义**：预测值与真实值的平均偏差
- **公式**：`MAE = mean(|y_true - y_pred|)`
- **越小越好**：0表示完美预测
- **适用场景**：关注预测的整体偏差

### 2. RMSE（Root Mean Square Error）- 均方根误差
- **含义**：预测误差的均方根
- **公式**：`RMSE = sqrt(mean((y_true - y_pred)^2))`
- **越小越好**：对大误差更敏感
- **适用场景**：关注预测的稳定性

### 3. 相关系数（Correlation Coefficient）
- **含义**：预测值与真实值的线性相关程度
- **取值范围**：-1到1
- **越接近1越好**：1表示完全正相关
- **适用场景**：评估预测的趋势一致性

### 4. MAPE（Mean Absolute Percentage Error）- 平均百分比误差
- **含义**：预测误差的相对百分比
- **公式**：`MAPE = mean(|y_true - y_pred| / |y_true|) * 100%`
- **越小越好**：0%表示完美预测
- **适用场景**：评估相对误差

---

## 🔍 如何解读图表

### 预测值vs真实值对比图
- **两条线重合度高** → 预测效果好
- **红线波动大** → 预测不稳定
- **红线系统性偏高/偏低** → 存在偏差

### 预测误差时间序列图
- **误差围绕0波动** → 无系统性偏差
- **误差趋势向上/向下** → 存在趋势性偏差
- **误差波动范围小** → 预测稳定性好

### 散点图
- **点聚集在y=x线附近** → 预测准确
- **点分散** → 预测不准确
- **点在y=x线上方/下方** → 系统性高估/低估
- **相关系数接近1** → 预测趋势准确

---

## 💡 与其他模型的区别

### LSTM输出格式
```csv
y_true,y_pred
-0.4217,-0.0954
-0.3735,-0.1702
-0.3107,-0.2316
...
```
- **特点**：2列格式，标准化后的值
- **优势**：统一的对比展示
- **适用**：深度学习模型（LSTM、N-HiTS等）

### Prophet/LightGBM输出格式
```csv
region_1,region_2,region_3,...
245.3,312.7,189.4,...
238.1,305.2,192.8,...
...
```
- **特点**：多列格式，每列一个区域
- **优势**：多区域同时展示
- **适用**：统计模型和机器学习模型

---

## 🛠️ 技术细节

### 修改的文件
- **ui/result_analysis.py** (第143-249行)

### 核心逻辑
```python
# 检测LSTM输出格式
is_pair_format = 'y_pred' in predictions.columns and 'y_true' in predictions.columns

if is_pair_format:
    # 专门的LSTM可视化处理
    # 1. 折线图：y_true vs y_pred
    # 2. 误差图：y_pred - y_true
    # 3. 散点图：scatter(y_true, y_pred)
    # 4. 统计卡片：MAE, RMSE, 相关系数, MAPE
    return  # 结束，不继续处理
else:
    # 原有的多区域格式处理
    # ...
```

### 关键特性
- ✅ 自动格式识别
- ✅ 专门的可视化处理
- ✅ 详细的统计指标
- ✅ 美观的图表布局
- ✅ 中文字体支持

---

## 📝 示例数据

### 典型的LSTM预测结果
```python
# 加载预测结果
predictions = pd.read_csv('output/lstm_predictions.csv')

print(predictions.head())
#      y_true    y_pred
# 0  -0.4217  -0.0954
# 1  -0.3735  -0.1702
# 2  -0.3107  -0.2316
# 3  -0.4194  -0.2822
# 4  -0.3633  -0.3360

# 计算指标
mae = np.mean(np.abs(predictions['y_true'] - predictions['y_pred']))
rmse = np.sqrt(np.mean((predictions['y_true'] - predictions['y_pred'])**2))
corr = np.corrcoef(predictions['y_true'], predictions['y_pred'])[0, 1]

print(f"MAE: {mae:.4f}")    # MAE: 0.1234
print(f"RMSE: {rmse:.4f}")  # RMSE: 0.2345
print(f"相关系数: {corr:.4f}") # 相关系数: 0.9876
```

---

## 🎯 最佳实践

### 1. 训练模型
```python
# 推荐参数（交通流量预测）
hidden_size = 128      # 隐藏层大小
num_layers = 2         # LSTM层数
dropout = 0.2          # Dropout率
batch_size = 64        # 批次大小
epochs = 50            # 训练轮数
learning_rate = 0.001  # 学习率
```

### 2. 查看结果
- 先查看"预测结果"选项卡，了解整体效果
- 重点关注MAE和相关系数
- 通过散点图判断是否有系统性偏差
- 通过误差图判断误差分布是否均匀

### 3. 改进模型
- **MAE较大** → 增加模型复杂度（hidden_size、num_layers）
- **相关系数低** → 增加训练轮数（epochs）
- **误差波动大** → 增加Dropout率
- **系统性偏差** → 检查数据预处理和归一化

---

## ❓ 常见问题

### Q1: 为什么LSTM输出是标准化的值？

**A**: LSTM模型在训练前对数据进行了标准化（StandardScaler），输出也是标准化后的值。这有助于：
- 加速训练收敛
- 提高数值稳定性
- 避免梯度消失/爆炸

如需原始值，需要进行反标准化。

### Q2: 如何判断LSTM预测效果好不好？

**A**: 综合以下指标：
- **MAE < 0.2**：较好
- **RMSE < 0.3**：较好
- **相关系数 > 0.9**：优秀
- **散点图紧密围绕y=x线**：优秀

### Q3: 散点图中的点偏离y=x线是什么原因？

**A**: 可能的原因：
- **系统性偏高/偏低**：模型有偏差，需要调整
- **分散**：预测不稳定，需要增加模型复杂度
- **非线性偏离**：可能需要更复杂的模型结构

### Q4: 误差图中出现明显趋势怎么办？

**A**: 误差应该随机分布在0附近。如果有趋势：
- **向上趋势**：模型逐渐低估，可能需要更长的训练窗口
- **向下趋势**：模型逐渐高估，可能过拟合
- **周期性波动**：可能未捕捉到某些季节性模式

### Q5: 可以导出高清图表吗？

**A**: 当前前端展示的图表可以右键保存。如需高清图表，可以在训练时生成的PNG文件（`output/lstm_predictions_plot.png`）中查看。

---

## 📚 相关文档

- **模型训练指南**：查看 `ui/model_training.py` 中的LSTM参数说明
- **Prophet可视化**：查看 `PROPHET_INSTALLATION.md`
- **模型对比分析**：查看 `MODEL_COMPARISON.md`

---

## 🎊 总结

✅ **自动识别LSTM格式**，无需手动配置
✅ **3种可视化图表**，全方位展示预测效果
✅ **4个关键指标**，量化评估模型性能
✅ **美观的界面**，支持中文字体
✅ **详细的说明**，帮助用户理解结果

**立即体验LSTM预测结果的全新可视化效果！** 🚀

---

**更新人**: Claude Code Assistant
**更新日期**: 2025-11-21
**版本**: v2.1 (LSTM可视化增强)
